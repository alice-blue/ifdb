<?php

include_once "util.php";
include_once "login-check.php";
include_once "dbconnect.php";

if ($_SERVER['REQUEST_METHOD'] != 'POST') {
    http_response_code(405);
    echo "405 Method Not Allowed";
    exit();
}

// connect to the database
$db = dbConnect();
if ($db == false)
    send_action_response("Not Saved", "An error occurred connecting to the database. "
                         . "Please try again later.");

// process the request
$input_json = json_decode(file_get_contents('php://input'), true);
$id = $input_json['id'] ?? null;

if (isEmpty($id))
    send_action_response(
        "Not Saved", "No game was specified in the tag request.");

// make sure we process any persistent login state
$userid = checkPersistentLogin();

$adminPriv = false;
if ($userid) {
    $result = mysqli_execute_query($db, "select privileges from users where privileges like '%A%' and id = ?", [$userid]);
    $adminPriv = mysqli_fetch_row($result);
}

if (!$adminPriv) {
    http_response_code(403);
    exit("Only administrators are allowed to delete tags.");
}

// make sure the game is valid
$qid = mysql_real_escape_string($id, $db);
$result = mysql_query("select id from games where id = '$qid'", $db);
if (mysql_num_rows($result) == 0)
    send_action_response("Not Saved",
                         "This tag request refers to a non-existent game.");

$tags = [];

foreach(($input_json['tags'] ?? []) as $tag) {
    // trim it
    $tag = trim($tag);

    // if it's not an empty string, add it to the list
    if (strlen($tag))
        $tags[] = $tag;
}

foreach ($tags as $t) {
    $t = mysql_real_escape_string($t, $db);
    $result = mysql_query("delete from gametags where gameid = '$qid' and tag ='$t'", $db);

    if (!$result)
        break;
}




// copy the new full set of tags for the game into the GAMES table
if ($result) {

    $result = mysql_query(
        "select tag from gametags where gameid = '$qid'", $db);

    for ($i = 0, $allTags = array(), $tagList = array(), $cnt = mysql_num_rows($result) ; $i < $cnt ; $i++) {
        $curTag = mysql_result($result, $i, "tag");
        $allTags[] = $curTag;
        $tagList[] = "'" . mysql_real_escape_string($curTag, $db) . "'";
    }

    if (count($allTags) != 0) {
        $allTags = implode(",", $allTags);
        $allTags = '\'' . mysql_real_escape_string($allTags, $db) . '\'';
        $tagList = implode(",", $tagList);
    } else {
        $allTags = "null";
        $tagList = "";
    }

    $result = mysql_query(
        "update games set tags = $allTags where id = '$qid'", $db);
}


// query the new counts
$tagInfo = [];
if ($result && $tagList) {

    $result = mysql_query(
        "select
           tag,
           sum(gameid = '$qid') as tagcnt,
           count(distinct gameid) as gamecnt
         from gametags
         where tag in ($tagList)
         group by tag
         having tagcnt != 0", $db);

    while ([$tag, $tagCnt, $gameCnt] = mysql_fetch_row($result)) {
        $tagInfo[] = [
            "name" => $tag,
            "tagcnt" => $tagCnt,
            "gamecnt" => $gameCnt,
        ];
    }
}

// explain what happened
if ($result) {
    send_action_response("Saved", false, ["tags" => $tagInfo]);
} else {
    send_action_response("Not Saved", "An error occurred updating the database. "
                         . "Please try again later.");
}

?>

<?php

include_once "session-start.php";
include_once "util.php";
include_once "login-check.php";
include_once "dbconnect.php";

if ($_SERVER['REQUEST_METHOD'] != 'POST') {
    http_response_code(405);
    echo "405 Method Not Allowed";
    exit();
}

// connect to the database
$db = dbConnect();
if ($db == false)
    send_action_response("Not Saved", "An error occurred connecting to the database. "
                         . "Please try again later.");

// get the request parameters
$gameid = get_req_data("game");
$add = (int)get_req_data("add");

// validate & quote the parameters
$qgameid = mysql_real_escape_string($gameid, $db);

// make sure it's a valid game
$result = mysql_query("select title from games where id='$qgameid'", $db);
if (mysql_num_rows($result) == 0)
    send_action_response("Not Saved", "The specified game doesn't exist in the "
                         . "database.");

// make sure we process any persistent login state
$userid = checkPersistentLogin();
if (!$userid && !logged_in(true)) {
    http_response_code(401);
    echo "401 Unauthorized";
    exit();
}

if (!$userid)
    send_action_response("Not Saved", "You must log in to use this feature.");

$progress = "QU107";
$result = mysql_query(
    "select gameid from wishlists
     where gameid='$qgameid' and userid='$userid'", $db);
$cnt = mysql_num_rows($result);
if ($cnt == 0 && $add) {
    // it's not already in the list, so insert it
    $progress = "IN108";
    $sql = "insert into wishlists (gameid, userid, date_added)
             values ('$qgameid', '$userid', now())";
        $result = mysql_query($sql, $db);
} else if ($cnt != 0 && !$add) {
    // it was in the wish list, but they want to remove it, so delete the row
    $progress = "DL109";
    $sql = "delete from wishlists
            where gameid='$qgameid' and userid='$userid'";
    $result = mysql_query($sql, $db);
}

if ($result) {

    // get the new count to send with the reply
    $result = mysql_query(
        "select count(userid) from wishlists
         where gameid='$qgameid'", $db);
    list($newCnt) = mysql_fetch_row($result);

    // send the success reply
    send_action_response("Saved", null, ["newCount" => $newCnt]);
}
else
    send_action_response("Not Saved", "An error occurred updating the database "
                         . "(failed operation: $progress). Please try again later.");

?>
